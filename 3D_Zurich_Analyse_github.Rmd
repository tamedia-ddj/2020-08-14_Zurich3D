---
title: "Zurich 3D"
author: "Patrick Meier"
date: "7. August 2020"
output:
  html_document:
    number_sections: true
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
    theme: simplex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, results = "hide")
# knitr::knit(..., encoding = getOption("encoding")) 
warnings()
```


```{r intro, results = "hide", message = FALSE}
library(sf)
library(leaflet)
library(rgdal)
library(RColorBrewer)
library(knitr)
library(kableExtra) # nice tables
library(fasterize) # -->Raster
library(raster)  # ACHTUNG raster() masked von "raster"
library(DT) # also nice tables (interactive sorting)
library(RCurl) # upload to ftp
library(tidyverse) # ACHTUNG raster() masked von "raster"

# Historsichwer vergleich: https://www.stadt-zuerich.ch/content/prd/de/index/statistik/publikationen-angebote/publikationen/webartikel/2018-01-30_Zuerich-waechst-in-die-Breite-und-in-die-Hoehe.html

options(encoding = "UTF-8")
```


# Übersicht
Analyse der Entwicklung der Gebäudehöhen in der Stadt Zürich zwischen 2012 und jetzt (August 2020).

# Daten

## Quartierdefinitionen 
Von Zürich Open Data

```{r}
## Read Quartiergrenzen from Shapefile
grenzen <- st_read("Data_input/Quartiergrenzen/data/stzh.adm_statistische_quartiere_map_polygon.shp")
plot(grenzen$geometry, main = "Statistische Quartiere")  

knitr::kable(grenzen, digits = 0) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>% 
  scroll_box(height = "200px", fixed_thead = TRUE)

# datatable(st_drop_geometry(grenzen), class = 'cell-border stripe')

```


## Gebäudedata 

Daten von Zürich Open Data. Shapefiles mit den Grundrissen aller Gebäude. Die Höhe der Gebäude ist als Attribut hinterlegt (2.5 D)

aktueller Stand: https://data.stadt-zuerich.ch/dataset/geo_3d_blockmodell_lod1

Stand 2012: https://data.stadt-zuerich.ch/dataset/geo_3d_blockmodell_lod1_jahresendstand_2012

Detailiertere Metadatenbeschreibung: https://www.stadt-zuerich.ch/content/dam/stzh/ted/Deutsch/geoz/Geodaten_und_Plaene/Formulare_und_%20Merkblaetter/Technische_Datenbeschreibung_3D_Produkte.pdf

„Quelle: Stadt Zürich“  

Es sind sowohl real existierende Gebäude erfasst, als auch eingereichte oder freigegebene Baubewilligungen. Für den Stand 2012 werden nur die real existierenden Gebäude und bewilligten Baubewilligungen berücksichtigt. Für den aktuellen Stand werden auch die eingereichten, aber noch nicht freigegebenen Baubewilligungen berücksichtigt.

Eingelesen werden die aufbereiteten Daten, bei denen bereits der Kreis und das Quartier für alle Gebäude hinterlegt wurden:

```{r import, results = "markup"}

## read data ####
## Und korrigiere sofort alle Höhen um 3 Meter nach unter, weil diese von 3 Metern im Boden aus gemessen werden

shp_2_5_2012_all <- st_read("Data_output/2012_buildings.geojson", stringsAsFactors = FALSE, as_tibble=TRUE) %>%
  mutate(h_boden = h_boden + 3) %>%
  mutate(h_rel_trau = h_rel_trau - 3) %>%
  mutate(h_rel_firs = h_rel_firs - 3) %>%
  mutate(h_rel_mean = h_rel_mean - 3)

shp_2_5_aktuell_all <- st_read("Data_output/aktuell_buildings.geojson", stringsAsFactors = FALSE, as_tibble=TRUE) %>%
  mutate(h_boden = h_boden + 3) %>%
  mutate(h_rel_trau = h_rel_trau - 3) %>%
  mutate(h_rel_firs = h_rel_firs - 3) %>%
  mutate(h_rel_mean = h_rel_mean - 3)
```


Ausschnitt Daten:

```{r, results = "markup"}
knitr::kable(shp_2_5_aktuell_all[1:5, ], caption =  "", digits = 0) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>%
  scroll_box(width = "1080", height = "250px", fixed_thead = TRUE)
```


Status der Gebäude:  
* Baubewilligung eingereicht  
* Baubewilligung freigegeben  
* Gebäude erstellt
* Gebäude real existierend

```{r, results = "hold"}
print("2012:")
table(shp_2_5_2012_all$sta)

print("Aktuell:")
table(shp_2_5_aktuell_all$sta)
```


Grundfläche und Volumen pro Gebäude werden berechnet.

```{r}
## calculate average height per quarter ####

# add area per building
shp_2_5_2012_all <- shp_2_5_2012_all %>%  mutate(area = as.numeric(st_area(shp_2_5_2012_all)))
shp_2_5_aktuell_all <- shp_2_5_aktuell_all %>%  mutate(area = as.numeric(st_area(shp_2_5_aktuell_all)))


# add volume per building FIRSTHöHE
shp_2_5_2012_all <- shp_2_5_2012_all %>%  mutate(volume_firs = area * h_rel_firs)
shp_2_5_aktuell_all <- shp_2_5_aktuell_all %>%  mutate(volume_firs = area * h_rel_firs)

# add volume per building TRAUFFHöHE
shp_2_5_2012_all <- shp_2_5_2012_all %>%  mutate(volume_trauf = area * h_rel_trau)
shp_2_5_aktuell_all <- shp_2_5_aktuell_all %>%  mutate(volume_trauf = area * h_rel_trau)

```

## Daten Einschränkung
Es werden nur eigentliche Gebäude (Typ BB, Bodenbedeckung) berücksichtigt.
Sogenannte "Einzelobjekte" (EO) werden nicht berücksichtigt
(dies sind z.b. Brücken, Auffahrten zu Parkhäusern, aber auch die Bahnhofshalle)

Folgende Gebäudetypen werden unterschieden:  
BB00: Gebaeude_Verwaltung  
BB01: Gebaeude_Wohngebaeude  
BB02: Gebaeude_Land_Forstwirtschaft  
BB03: Gebaeude_Verkehr  
BB04: Gebaeude_Handel  
BB05: Gebaeude_Industrie_Gewerbe  
BB06: Gebaeude_Gastgewerbe  
BB07: Gebaeude_Nebengebaeude  
EO08: Bruecke_Passerelle  
EO12: Pfeiler  
EO13: Unterstand  
EO14: Silo_Turm_Gasometer  
EO16: Hochkamin  
EO18: Mast_Antenne  

```{r results = "markup"}
# colnames(shp_2_5_aktuell_all)
# table(shp_2_5_aktuell_all$art)
# table(shp_2_5_aktuell_all$otype)
# table(shp_2_5_aktuell_all$bem)
# shp_2_5_aktuell_all$egid
# 
# 
# aa <- shp_2_5_aktuell_all %>% filter(otype == "EO") %>% st_transform(4326) %>% filter(art == 6)
# table(aa$art)
# 
# m <- leaflet() %>% addTiles() %>%
#                    addPolygons(data = aa, color = "black", weight = 10, fillOpacity = 0.5,
#                                 popup = ~str_c('status: ', sta, "<br>"))
# m
```


## Daten Check
Es gibt Overlaps der Gebäudegeometrien:  
* Geometrien die aneinandergrenzen überlappen sich manchmal minimal --> Kein Problem.  
* Bei gewissen Bauten ist sowohl ein "reales" Gebäude erfasst als auch ein Bauprojekt mit bewilligter Genehmigung. Das ist ein Problem für die Auswertung.  

Es wird Folgendes gemacht um dieses Problem zu umgehen:
* Bei Überlappungen 2012 werden nur bestehende Bauten berücksichtigt (dies entspricht "real" und "erstellt" im sta-Attribut) und aktuell nur die Bauprojekte. Wenn keine Überlappungen herrshen werden reale Gebäude und Bauprojekte berücksichtigt.

```{r, eval = TRUE, echo = TRUE, results = "hide"}
#### Data Check
# Auflösen der Überlappungen zwischen existierenden Gebäuden und Bauprojekten.
# Wenn use_fancy=TRUE werden 2012 nur Bestehende Bauten zu berücksichtigen und aktuell nur die Bauprojekte.
# Wenn use_fancy=FALSE werden immer nur die "realen" Bauten berücksichtigt

use_fancy = TRUE
```


```{r, eval = TRUE, echo = TRUE, results = "hide"}
#### Data Check
# Auflösen der Überlappungen zwischen existierenden Geäbuden und Bauprojekten.
# Ziel ist bei Überalppungen, 2012 nur Bestehende Bauten zu berücksichtigen und aktuell nur die Bauprojekte.

if(use_fancy){
  
  quartier_namen <- grenzen$qname
    
  dat_2012_freigegeben <- shp_2_5_2012_all %>% filter(sta == "freigegeben") %>% 
                                               filter(otype == "BB") %>% filter(Quartier %in% quartier_namen)
  dat_2012_real        <- shp_2_5_2012_all %>% filter(sta %in% c("real", "erstellt")) %>% 
                                               filter(otype == "BB") %>% filter(Quartier %in% quartier_namen)
                                               
  dat_aktuell_freigegeben <- shp_2_5_aktuell_all %>% filter(sta == "freigegeben") %>%
                                                     filter(otype == "BB") %>% filter(Quartier %in% quartier_namen)
  dat_aktuell_real        <- shp_2_5_aktuell_all %>% filter(sta  %in% c("real", "erstellt")) %>%
                                                     filter(otype == "BB") %>% filter(Quartier %in% quartier_namen)
  
  
  ### Check intersections zwischen real und freigegebenen Projekten
  
  ## 2012
  complete_2012 <- rbind(dat_2012_real, dat_2012_freigegeben) # Reihenfolge ist wichtig! Erst real, dann freigegeben! Weil die freigegebenen die überlappt werden, werden entfernt!
  
  # loope durch alle Quartiere, viel schneller!
  differences_2012 <- data.frame()
  for (quartier_name in quartier_namen){
    print(quartier_name)
    differences_2012 <- rbind(differences_2012, st_difference(complete_2012[complete_2012$Quartier == quartier_name, ]))
  }
  
  # für graphischen check
  # d_2012_freigegeben <- differences_2012 %>% filter(sta == "freigegeben") %>% filter(Quartier == "Escher Wyss") %>% st_transform(4326)
  # d_2012_real <- differences_2012 %>% filter(sta %in% c("real", "erstellt")) %>% filter(Quartier == "Escher Wyss") %>% st_transform(4326)
  # 
  # # für graphischen check
  # m <- leaflet() %>% addTiles() %>% addPolygons(data = d_2012_freigegeben, color = "purple", opacity = 0.4,
  #                                               popup = ~str_c('status: ', sta, "<br>",
  #                                                              'Traufhöhe: ', h_rel_trau, "<br>",
  #                                                              'EGID: ', egid)) %>%
  #                                   addPolygons(data = d_2012_real, color = "yellow", opacity = 0.4,
  #                                               popup = ~str_c('status: ', sta, "<br>",
  #                                                              'Traufhöhe: ', h_rel_trau, "<br>",
  #                                                              'EGID: ', egid))
  # m
  
  
  ## aktuell
  # Reihenfolge ist wichtig! Erst FREIGEGEBEN dann real! Weil die realen die überlappt werden, werden entfernt!
  complete_aktuell <- rbind(dat_aktuell_freigegeben, dat_aktuell_real)
  
  # loope durch alle Quartiere, viel schneller!
  differences_aktuell <- data.frame()
  for (quartier_name in quartier_namen){
    print(quartier_name)
    differences_aktuell <- rbind(differences_aktuell, st_difference(complete_aktuell[complete_aktuell$Quartier == quartier_name, ]))
    
  }
  
  # für graphischen check
  # d_aktuell_freigegeben <- differences_aktuell %>% filter(sta == "freigegeben") %>% filter(Quartier == "Escher Wyss") %>% st_transform(4326)
  # d_aktuell_real <- differences_aktuell %>% filter(sta == "real") %>% filter(Quartier == "Escher Wyss") %>% st_transform(4326)
  # 
  # m <- leaflet() %>% addTiles() %>% addPolygons(data = d_aktuell_freigegeben, color = "purple", opacity = 0.4,
  #                                               popup = ~str_c('status: ', sta, "<br>",
  #                                                              'Traufhöhe: ', h_rel_trau, "<br>",
  #                                                              'EGID: ', egid)) %>%
  #                                   addPolygons(data = d_aktuell_real, color = "yellow", opacity = 0.4,
  #                                               popup = ~str_c('status: ', sta, "<br>",
  #                                                              'Traufhöhe: ', h_rel_trau, "<br>",
  #                                                              'EGID: ', egid))
  # m
}
```


# Analyse Gebäudehöhen

## Veränderung Ø-Gebäudehöhe (ganze Stadt) 

Berücksichtigte Gebäude: Siehe Kapitel "Daten Check".

Die Gebäudehöhen werden gewichtet mit der jeweiligen Grundfläche.

```{r, results = "hold"}
## Übernahme der Daten aus "Daten Check"

if(use_fancy){
  
  buildings_2012 <- differences_2012
  buildings_aktuell <- differences_aktuell
  
} else{
  
## oder einfachere Lösung anwenden, bei Bedarf:
  buildings_2012 <- shp_2_5_2012_all %>% filter(sta %in% c("real", "erstellt")) %>%
                                       filter(otype == "BB")
  buildings_aktuell <- shp_2_5_aktuell_all %>% filter(sta %in% c("real", "erstellt")) %>%
                                             filter(otype == "BB")
}


```


### Firsthöhe
Durchschnittliche Gebäudehöhe in der Ganzen Stadt basierend auf der Firsthöhe:
```{r, results = "hold"}
height_2012_average <- sum(buildings_2012$volume_firs) / sum(buildings_2012$area)
height_aktuell_average <- sum(buildings_aktuell$volume_firs) / sum(buildings_aktuell$area)
dif_height_average <- height_aktuell_average - height_2012_average

print("Firsthöhe: ")
print(str_c("Durchschnittliche Höhe 2012: ", round(height_2012_average, 2), " m"))
print(str_c("Durchschnittliche Höhe Aktuell: ", round(height_aktuell_average, 2), " m"))
print(str_c("Die Stadt ist also heute im Durchschnitt ", round(dif_height_average, 2), " m höher als 2012"))

```


### Traufhöhe
Durchschnittliche Gebäudehöhe in der Ganzen Stadt basierend auf der Traufhöhe:

```{r, results = "hold"}

height_2012_average <- sum(buildings_2012$volume_trauf) / sum(buildings_2012$area)
height_aktuell_average <- sum(buildings_aktuell$volume_trauf) / sum(buildings_aktuell$area)
dif_height_average <- height_aktuell_average - height_2012_average

print("Trauffhöhe:")
print(str_c("Durchschnittliche Höhe 2012: ", round(height_2012_average, 2), " m"))
print(str_c("Durchschnittliche Höhe Aktuell: ", round(height_aktuell_average, 2), " m"))
print(str_c("Die Stadt ist also heute im Durchschnitt ", round(dif_height_average, 2), " m höher als 2012"))

```


## Ø-Gebäudehöhe pro Quartier
Berechnet mit der Firsthöhe der Gebäude, und gewichtet mit der jeweiligen Grundfläche. Tabellen sind nach der durchschnittlichen Firsthöhe sortiert.

### Firsthöhe

#### Aktueller Gebäudestand (Firsthöhe)
```{r, results = "markup"}
temp_quartiere_volume <- buildings_aktuell %>% st_drop_geometry() %>% group_by(Quartier) %>% summarise(sum_volume_firs = sum(volume_firs))
temp_quartiere_area <- buildings_aktuell %>% st_drop_geometry() %>% group_by(Quartier) %>% summarise(sum_area = sum(area))

res_quartiere_aktuell <- temp_quartiere_volume %>% left_join(temp_quartiere_area) %>%
                                                   left_join(grenzen, by = c("Quartier" = "qname")) %>% 
                                                   mutate(avg_height_firs = sum_volume_firs / sum_area) 

res_quartiere_aktuell$avg_height_firs <- res_quartiere_aktuell$avg_height_firs

st_geometry(res_quartiere_aktuell) <- st_geometry(res_quartiere_aktuell$geometry)

res_quartiere_aktuell[, "color"] <- "lightgreen"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_firs > 15, "color"] <- "green"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_firs > 17, "color"] <- "yellow"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_firs > 19, "color"] <- "orange"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_firs > 21, "color"] <- "red"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_firs > 23, "color"] <- "darkred"

res_quartiere_aktuell %>% st_drop_geometry() %>%
                          dplyr::select(-c("objectid", "objid", "qnr", "knr")) %>% 
                          arrange(-avg_height_firs) %>% 
                          knitr::kable( caption =  "Aktueller Gebäudestand: Durchschnittliche Firsthöhe", digits = 1) %>%
                          kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>% 
                          scroll_box(height = "400px", fixed_thead = TRUE)

```


#### 2012 Gebäudestand (Firsthöhe)
```{r, results = "markup"}
temp_quartiere_volume <- buildings_2012 %>% st_drop_geometry() %>% group_by(Quartier) %>% summarise(sum_volume_firs = sum(volume_firs))
temp_quartiere_area <- buildings_2012 %>% st_drop_geometry() %>% group_by(Quartier) %>% summarise(sum_area = sum(area))

res_quartiere_2012 <- temp_quartiere_volume %>% left_join(temp_quartiere_area) %>%
                                                   left_join(grenzen, by = c("Quartier" = "qname")) %>% 
                                                   mutate(avg_height_firs = sum_volume_firs / sum_area) 

res_quartiere_2012$avg_height_firs <- res_quartiere_2012$avg_height_firs

st_geometry(res_quartiere_2012) <- st_geometry(res_quartiere_aktuell$geometry)

res_quartiere_2012[, "color"] <- "lightgreen"
res_quartiere_2012[res_quartiere_2012$avg_height_firs > 15, "color"] <- "green"
res_quartiere_2012[res_quartiere_2012$avg_height_firs > 17, "color"] <- "yellow"
res_quartiere_2012[res_quartiere_2012$avg_height_firs > 19, "color"] <- "orange"
res_quartiere_2012[res_quartiere_2012$avg_height_firs > 21, "color"] <- "red"
res_quartiere_2012[res_quartiere_2012$avg_height_firs > 23, "color"] <- "darkred"

res_quartiere_2012 %>% st_drop_geometry() %>%
                       dplyr::select(-c("objectid", "objid", "qnr", "knr")) %>% 
                       arrange(-avg_height_firs) %>% 
                       knitr::kable( caption =  "Gebäudestand 2012: Durchschnittliche Firsthöhe", digits = 1) %>%
                       kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>% 
                       scroll_box(height = "400px", fixed_thead = TRUE)
```


#### Veränderung 2012 bis heute (Firsthöhe)

Differenz der durchschnittlichen Firsthöhe zwischen 2012 und heute (Stand Juli 2020).

rot/orange: Zunahme der Gebäudehöhe  
Grün: Abnahme der Gebäudehöhe

```{r, results = "markup"}

res_quartiere_dif_firs <- res_quartiere_2012 %>% dplyr::select(c("Quartier", "objectid", "objid", "qnr", "knr", "kname", "geometry"))
res_quartiere_dif_firs[, "avg_height_firs_2012"] <- st_drop_geometry(res_quartiere_2012[, "avg_height_firs"])
res_quartiere_dif_firs[, "avg_height_firs_aktuell"] <- st_drop_geometry(res_quartiere_aktuell[, "avg_height_firs"])

# increase:
res_quartiere_dif_firs <- res_quartiere_dif_firs %>% mutate(avg_height_firs_increase = avg_height_firs_aktuell - avg_height_firs_2012)

# increase in percent:
res_quartiere_dif_firs <- res_quartiere_dif_firs %>% mutate(increase_firs_percent = avg_height_firs_increase/avg_height_firs_2012*100)

# Farben für Grafik 
res_quartiere_dif_firs[, "color"] <- "green"
res_quartiere_dif_firs[res_quartiere_dif_firs$avg_height_firs_increase > -0.25, "color"] <- "white"
res_quartiere_dif_firs[res_quartiere_dif_firs$avg_height_firs_increase > +0.25, "color"] <- "orange"
res_quartiere_dif_firs[res_quartiere_dif_firs$avg_height_firs_increase > +0.75, "color"] <- "red"
res_quartiere_dif_firs[res_quartiere_dif_firs$avg_height_firs_increase > +1.25, "color"] <- "darkred"


## Tabelle 
res_quartiere_dif_firs %>% st_drop_geometry() %>%
                           dplyr::select(-c("objectid", "objid", "qnr", "knr")) %>% 
                           arrange(-avg_height_firs_increase) %>% 
                           knitr::kable(caption =  "Veränderung der durchschnittliche Firsthöhe in Metern", digits = 1,
                                        col.names = c("Quartier", "kname", 
                                                      "Ø-Höhe 2012", "Ø-Höhe aktuell", "Erhöhung", "Erhöhung %", "Farbe")) %>%
                           kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>% 
                           scroll_box(height = "400px", fixed_thead = TRUE)

## Plot
df_plot <- res_quartiere_dif_firs %>% st_transform(4326)

m <- leaflet() %>% addTiles() %>%
                   addPolygons(data = df_plot, color = "black", fillColor  = ~color, weight = 2, fillOpacity = 0.5,
                               popup = ~str_c('Durchschnittliche Firsthöhe Heute: ', round(avg_height_firs_aktuell, 1), " m", "<br>",
                                              'Durchschnittliche Erhöhung 2012 bis heute: ', round(avg_height_firs_increase, 1), " m", "<br>",
                                              "Quartier: ", Quartier))
m
```


### Traufhöhe:

#### Aktueller Gebäudestand (Traufhöhe)
```{r, results = "markup"}
temp_quartiere_volume <- buildings_aktuell %>% st_drop_geometry() %>% group_by(Quartier) %>% summarise(sum_volume_trauf = sum(volume_trauf))
temp_quartiere_area <- buildings_aktuell %>% st_drop_geometry() %>% group_by(Quartier) %>% summarise(sum_area = sum(area))

res_quartiere_aktuell <- temp_quartiere_volume %>% left_join(temp_quartiere_area) %>%
                                                   left_join(grenzen, by = c("Quartier" = "qname")) %>% 
                                                   mutate(avg_height_trauf = sum_volume_trauf / sum_area) 

res_quartiere_aktuell$avg_height_trauf <- res_quartiere_aktuell$avg_height_trauf

st_geometry(res_quartiere_aktuell) <- st_geometry(res_quartiere_aktuell$geometry)

res_quartiere_aktuell[, "color"] <- "lightgreen"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_trauf > 15, "color"] <- "green"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_trauf > 17, "color"] <- "yellow"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_trauf > 19, "color"] <- "orange"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_trauf > 21, "color"] <- "red"
res_quartiere_aktuell[res_quartiere_aktuell$avg_height_trauf > 23, "color"] <- "darkred"

res_quartiere_aktuell %>% st_drop_geometry() %>%
                       dplyr::select(-c("objectid", "objid", "qnr", "knr")) %>% 
                       arrange(-avg_height_trauf) %>% 
                       knitr::kable(caption =  "Aktueller Gebäudestand: Durchschnittliche Traufhöhe",
                                    digits = 1) %>%
                       kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>% 
                       scroll_box(height = "400px", fixed_thead = TRUE)

```

#### 2012 Gebäudestand (Traufhöhe)
```{r, results = "markup"}
temp_quartiere_volume <- buildings_2012 %>% st_drop_geometry() %>% group_by(Quartier) %>% summarise(sum_volume_trauf = sum(volume_trauf))
temp_quartiere_area <- buildings_2012 %>% st_drop_geometry() %>% group_by(Quartier) %>% summarise(sum_area = sum(area))

res_quartiere_2012 <- temp_quartiere_volume %>% left_join(temp_quartiere_area) %>%
                                                   left_join(grenzen, by = c("Quartier" = "qname")) %>% 
                                                   mutate(avg_height_trauf = sum_volume_trauf / sum_area) 

res_quartiere_2012$avg_height_trauf <- res_quartiere_2012$avg_height_trauf

st_geometry(res_quartiere_2012) <- st_geometry(res_quartiere_aktuell$geometry)

res_quartiere_2012[, "color"] <- "lightgreen"
res_quartiere_2012[res_quartiere_2012$avg_height_trauf > 15, "color"] <- "green"
res_quartiere_2012[res_quartiere_2012$avg_height_trauf > 17, "color"] <- "yellow"
res_quartiere_2012[res_quartiere_2012$avg_height_trauf > 19, "color"] <- "orange"
res_quartiere_2012[res_quartiere_2012$avg_height_trauf > 21, "color"] <- "red"
res_quartiere_2012[res_quartiere_2012$avg_height_trauf > 23, "color"] <- "darkred"

res_quartiere_2012 %>% st_drop_geometry() %>%
                       dplyr::select(-c("objectid", "objid", "qnr", "knr")) %>% 
                       arrange(-avg_height_trauf) %>% 
                       knitr::kable( caption =  "Gebäudestand 2012: Durchschnittliche Traufhöhe", digits = 1) %>%
                       kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>% 
                       scroll_box(height = "400px", fixed_thead = TRUE)
```


#### Veränderung 2012 bis heute (Traufhöhe)

Differenz der durchschnittlichen Traufhöhe zwischen 2012 und heute (Stand Juli 2020).

rot/orange: Zunahme der Gebäudehöhe  
Grün: Abnahme der Gebäudehöhe

```{r, results = "markup"}

res_quartiere_dif_trauf <- res_quartiere_2012 %>% dplyr::select(c("Quartier", "objectid", "objid", "qnr", "knr", "kname", "geometry"))
res_quartiere_dif_trauf[, "avg_height_trauf_2012"] <- st_drop_geometry(res_quartiere_2012[, "avg_height_trauf"])
res_quartiere_dif_trauf[, "avg_height_trauf_aktuell"] <- st_drop_geometry(res_quartiere_aktuell[, "avg_height_trauf"])

# increase:
res_quartiere_dif_trauf <- res_quartiere_dif_trauf %>% mutate(avg_height_trauf_increase = avg_height_trauf_aktuell - avg_height_trauf_2012)

# increase in percent:
res_quartiere_dif_trauf <- res_quartiere_dif_trauf %>% mutate(increase_trauf_percent = avg_height_trauf_increase/avg_height_trauf_2012*100)

# Farben für Grafik 
res_quartiere_dif_trauf[, "color"] <- "green"
res_quartiere_dif_trauf[res_quartiere_dif_trauf$avg_height_trauf_increase > -0.25, "color"] <- "white"
res_quartiere_dif_trauf[res_quartiere_dif_trauf$avg_height_trauf_increase > +0.25, "color"] <- "orange"
res_quartiere_dif_trauf[res_quartiere_dif_trauf$avg_height_trauf_increase > +0.75, "color"] <- "red"
res_quartiere_dif_trauf[res_quartiere_dif_trauf$avg_height_trauf_increase > +1.25, "color"] <- "darkred"

## Tabelle 
res_quartiere_dif_trauf %>% st_drop_geometry() %>%
                       dplyr::select(-c("objectid", "objid", "qnr", "knr")) %>% 
                       arrange(-avg_height_trauf_increase) %>% 
                       knitr::kable(caption =  "Veränderung der durchschnittliche Traufhöhe in Metern", digits = 1,
                                    col.names = c("Quartier", "kname", 
                                                  "Ø-Höhe 2012", "Ø-Höhe aktuell", "Erhöhung", "Erhöhung %", "Farbe")) %>%
                       kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>% 
                       scroll_box(height = "400px", fixed_thead = TRUE)

## Plot
df_plot <- res_quartiere_dif_trauf %>% st_transform(4326)

m <- leaflet() %>% addTiles() %>%
                   addPolygons(data = df_plot, color = "black", fillColor  = ~color, weight = 2, fillOpacity = 0.5,
                               popup = ~str_c('Durchschnittliche Traufhöhe Heute: ', round(avg_height_trauf_aktuell, 1), " m", "<br>",
                                              'Durchschnittliche Erhöhung 2012 bis heute: ', round(avg_height_trauf_increase, 1), " m", "<br>",
                                              "Quartier: ", Quartier))

m
```


### Traufhöhe vs. Firsthöhe
```{r, results = "markup"}

res_quartier_dif <- res_quartiere_dif_trauf %>% select(-c("color", "increase_trauf_percent")) %>% 
                                 left_join(st_drop_geometry(res_quartiere_dif_firs)[, c(
                                                                                        "avg_height_firs_2012", "avg_height_firs_aktuell", 
                                                                                        "avg_height_firs_increase",
                                                                                        "Quartier")], by = "Quartier")


colnames(res_quartier_dif)
res_quartier_dif %>% st_drop_geometry() %>%
                     dplyr::select(-c("objectid", "objid", "qnr", "knr")) %>% 
                     arrange(-avg_height_trauf_increase) %>% 
                     knitr::kable(caption =  "Veränderung der durchschnittlichen Gebäudehöhe in Metern", digits = 1,
                                  col.names = c("Quartier", "kname", 
                                                "Höhe 2012", 
                                                "Höhe Aktuell", 
                                                "Erhöhung",
                                                "Höhe 2012",
                                                "Höhe Aktuell",
                                                "Erhöhung")) %>%
                     kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>% 
                     add_header_above(c(" ", " ", "Traufhöhe" = 3, "Firsthöhe" = 3)) %>% 
                     scroll_box(height = "400px", fixed_thead = TRUE)

```


## Veränderungen auf Gebäude-Ebene
Hier werden ebenfalls nur die "Bodenbebauungs-" Gebäude verwendet.
Für die farbige Darstellung der Veränderung der Bauhöhen wird die Datengrundlage wie bei den Analysen weiter oben verwendet.  

Die schwarz gezeichneten Grundrisse entsprechen immer den real existierenden Gebäuden im aktuellen Zustand, ohne projektierte Bauten (da dies am ehesten dem Bild entspricht das sich zur Zeit dem Leser zeigt).
Zusätzlich werden zur besseren Lesbarkeit die Umrisse ALLER existierenden Bauten gezeichnet, also auch von Brücken und ähnlichen Bauten die in der Analyse nicht berücksichtigt werden.

```{r results = "markup"}
## Funktion um Rasterkarten zu speichern oder anzuzeigen
# 
# quartier_name <- grenzen$qnam
# quartier_name <- c("Wollishofen", "Leimbach")
# 
# 
# quartier_name <- "Altstetten"
# file_name <- "Saatlen"
# status <-  c("real", "erstellt", "freigegeben")
# status <-  c("real")
# store_switch <- TRUE
# building_type <- "BB"

store_png_scale <- function(quartier_name, file_name, store_switch){
  
  # Gebäudetyp (BB oder EO) und Status wird bereits oben (Daten Check) ausgewählt
  a = buildings_2012    %>% filter(Quartier %in% quartier_name) %>% st_cast("POLYGON")
  b = buildings_aktuell %>% filter(Quartier %in% quartier_name) %>% st_cast("POLYGON")
  
  table(a$sta)
  table(b$sta)
  
  ## Dargestellte Gebäude
  vector_buildings <- shp_2_5_aktuell_all %>% filter(sta %in% c("real", "erstellt")) %>% 
                                              filter(Quartier %in% quartier_name)

  vector_planned <-   shp_2_5_aktuell_all %>% filter(sta %in% c("freigegeben")) %>% 
                                              filter(Quartier %in% quartier_name)
  
  vector_grenzen <- grenzen %>% filter(qname %in% quartier_name)

  ## Dargestellte Grundrisse
  
  
  ## Erstelle Raster
  
  r_2012 <- raster(a, res = 1)
  r_aktuell <- raster(b, res = 1)

  ## Origin anpassen sonst Fehler (Wieso?)
  origin(r_2012) <- c(0, 0)
  origin(r_aktuell) <- c(0, 0)
  
  r_2012 <- a %>% fasterize(r_2012, field = "h_rel_trau", fun="sum")
  r_aktuell <- b %>% fasterize(r_aktuell, field = "h_rel_trau", fun="sum")
  
  r_2012@data@values[is.na(r_2012@data@values)] <- 0
  r_aktuell@data@values[is.na(r_aktuell@data@values)] <- 0
  
  ## Differenz
  r_dif <- r_aktuell - r_2012

  
  ## Speichern und darstellen
  if(store_switch){
    png(paste(file_name, "_2012-heute", '.png',sep=''),width=r_dif@ncols,height=r_dif@nrows)
  }
  
  cuts=c(130, 10, 2, -2, -10, -130) #set breaks
  # colors <- brewer.pal(5, "BrBG")
  colors <- c("#8c510a","#dfc27d", "#00000000", "#80cdc1", "#01665e")
  colors[3] <- "#00000000"
  
  plot(r_dif, maxpixels=r_dif@ncols*r_dif@nrows, breaks=cuts, col = colors) # main = " "
  plot(vector_buildings$geometry, add = TRUE)
  plot(vector_grenzen$geometry, color = "blue", add = TRUE)
  if(store_switch){
    dev.off()
  }
}


# # Generiere PNGs von allen Quartieren nur bei Bedarf aktivieren
# for (i in 1:length(grenzen$qname)){
#   quartier <- grenzen$qname[i]
#   print(quartier)
#   store_png_scale(quartier, str_c(quartier, "_inkl_proj"), TRUE)
# 
# }

```


## Leaflet Plots

```{r results = "markup"}
prep_leaflet_plots <- function(quartier_name, file_name){
  
  # Gebäudetyp (BB oder EO) und Status wird bereits oben (Daten Check) ausgewählt
  a = buildings_2012    %>% filter(Quartier %in% quartier_name) %>% st_cast("POLYGON")
  b = buildings_aktuell %>% filter(Quartier %in% quartier_name) %>% st_cast("POLYGON")
  
  table(a$sta)
  table(b$sta)
  
  ## Dargestellte Gebäude
  vector_buildings <- shp_2_5_aktuell_all %>% filter(sta %in% c("real", "erstellt")) %>% 
                                              filter(Quartier %in% quartier_name)

  vector_planned <-   shp_2_5_aktuell_all %>% filter(sta %in% c("freigegeben")) %>% 
                                              filter(Quartier %in% quartier_name)
  
  vector_grenzen <- grenzen %>% filter(qname %in% quartier_name)

  ## Dargestellte Grundrisse
  
  
  ## Erstelle Raster
  
  r_2012 <- raster(a, res = 1)
  r_aktuell <- raster(b, res = 1)

  ## Origin anpassen sonst Fehler (Wieso?)
  origin(r_2012) <- c(0, 0)
  origin(r_aktuell) <- c(0, 0)
  
  r_2012 <- a %>% fasterize(r_2012, field = "h_rel_trau", fun="sum")
  r_aktuell <- b %>% fasterize(r_aktuell, field = "h_rel_trau", fun="sum")
  
  r_2012@data@values[is.na(r_2012@data@values)] <- 0
  r_aktuell@data@values[is.na(r_aktuell@data@values)] <- 0
  
  ## Differenz
  r_dif <<- r_aktuell - r_2012

  ## Def Farben
  cuts <- c(130, 10, 2, -2, -10, -130) #set breaks
  colors_plot <<- c("#8c510a","#dfc27d", "#00000000", "#80cdc1", "#01665e")
  # colors_plot[3] <- "#00000000"
  col_pal <<- colorBin(colors_plot, domain = c(-130, 130), bins = cuts, na.color = "#00000000")

  ## Plot mit leaflet()
    
  vector_buildings[vector_buildings$sta == "erstellt", "sta"] <- "Gebaut"
  vector_buildings[vector_buildings$sta == "real", "sta"] <- "Gebaut"
  vector_planned[vector_planned$sta == "freigegeben", "sta"] <- "Geplant"
  
  table(vector_planned$sta)
  
  df_buildings <<- vector_buildings %>% st_transform(4326)
  df_planned <<- vector_planned %>% st_transform(4326)
  df_borders <<- vector_grenzen %>% st_transform(4326)
  
  
  ## 0 Werte auf NA, damit transpartent in leaflet()
  r_dif@data@values[r_dif@data@values == 0] <<- NA
  
  ## +/-2m Werte auf NA, damit transpartent in leaflet()
  r_dif@data@values[(r_dif@data@values < 2) & (r_dif@data@values > -2)] <<- NA
  
}
```


### Plot Hard
```{r results = "markup"}

prep_leaflet_plots("Hard")
m <- leaflet(options = leafletOptions(minZoom = 13, maxZoom = 18)) %>%  
                   addProviderTiles(providers$CartoDB.Positron) %>% 
                   setView(8.514483, 47.382471, zoom = 15) %>% 
                   addRasterImage(r_dif, opacity = 0.5, colors = col_pal) %>%
                   addPolygons(data = df_buildings, color = "black", weight = 2,
                               fill = TRUE, fillOpacity = 0,
                               popup = ~str_c("Gebäudehöhe: ", h_rel_trau, " m <br>",
                                              "Status: ", sta)) %>% 
                   addPolygons(data = df_planned, color = "black", weight = 2,
                               dashArray = c(5, 5),
                               fill = TRUE, fillOpacity = 0,
                               popup = ~str_c("Gebäudehöhe: ", h_rel_trau, " m <br>",
                                              "Status: ", sta)) %>% 
                   addPolygons(data = df_borders, color = "black", weight = 3,
                               dashArray = c(5, 5),
                               fill = FALSE, fillOpacity = 0) %>% 
                   addMarkers(8.510041, 47.381294,
                               label = "Hardau Hochhäuser",
                               labelOptions = labelOptions(noHide = T)) %>%
                   addMarkers(8.519395, 47.381831,
                               label = "Polizei- und Justizzentrum (PJZ)",
                               labelOptions = labelOptions(noHide = T)) %>%
                   addLegend(colors = rev(colors_plot[-3]),
                             labels = (c("Mehr als 10m", "2 bis 10m",
                                         # "Weniger als 2m", 
                                         "2 bis 10m tiefer", "mehr als 10 Meter tiefer")),
                             title = "Erhöhung seit 2012",
                             position = "bottomright") # %>% 
m
```


### Plot Escher Wyss

```{r results = "markup"}

prep_leaflet_plots("Escher Wyss")
m <- leaflet(options = leafletOptions(minZoom = 13, maxZoom = 18)) %>%  
                   addProviderTiles(providers$CartoDB.Positron) %>% 
                                  # providers$CartoDB.Positron
                                  # providers$Stamen.Toner
                                  # providers$Jawg.Light
                   setView(8.514555, 47.382545, zoom = 15) %>% 
                   addRasterImage(r_dif, opacity = 0.5, colors = col_pal) %>%
                   addPolygons(data = df_buildings, color = "black", weight = 2,
                               fill = TRUE, fillOpacity = 0,
                               popup = ~str_c("Gebäudehöhe: ", h_rel_trau, " m <br>",
                                              "Status: ", sta)) %>% 
                   addPolygons(data = df_planned, color = "black", weight = 2,
                               dashArray = c(5, 5),
                               fill = TRUE, fillOpacity = 0,
                               popup = ~str_c("Gebäudehöhe: ", h_rel_trau, " m <br>",
                                              "Status: ", sta)) %>% 
                   addPolygons(data = df_borders, color = "black", weight = 3,
                               dashArray = c(5, 5),
                               fill = FALSE, fillOpacity = 0) %>% 
                   addMarkers(8.511765, 47.390203,
                               label = "Hochschule der Künste",
                               labelOptions = labelOptions(noHide = T)) %>%
                   addMarkers(8.517221, 47.386053,
                               label = "Prime Tower",
                               labelOptions = labelOptions(noHide = T)) %>%
                   addLegend(colors = rev(colors_plot[-3]),
                             labels = (c("Mehr als 10m", "2 bis 10m",
                                         # "Weniger als 2m", 
                                         "2 bis 10m tiefer", "mehr als 10 Meter tiefer")),
                             title = "Erhöhung seit 2012",
                             position = "bottomright") # %>% 
m
```


## Statische PNG Plots

### Beispiele: Saatlen
```{r results = "markup"}

store_png_scale("Saatlen", "Saatlen", FALSE)
```

### Beispiele: Wollishofen
```{r results = "markup"}

store_png_scale("Wollishofen", "Wollishofen", FALSE)
```

### Beispiele: Altstetten
```{r results = "markup"}

store_png_scale("Altstetten", "Altstetten", FALSE)
```

### Beispiele: Seebach

```{r results = "markup"}

store_png_scale("Seebach", "Seebach", FALSE)
```

### Beispiele: Alt Wiedikon
```{r results = "markup"}

store_png_scale("Hirzenbach", "Hirzenbach", FALSE)
```

### Beispiele: Langstrasse
```{r results = "markup"}

store_png_scale("Langstrasse", "Langstrasse", FALSE)
```

### Beispiele: Wollishofen
```{r results = "markup"}

store_png_scale("Wollishofen", "Wollishofen", FALSE)
```

### Beispiele: Escher Wyss
```{r results = "markup"}

store_png_scale("Escher Wyss", "Escher Wyss", FALSE)
```



# Analyse Hochhäuser
Wie viele Hochhäuser (höher als 25 m) gibt es?  

Das kantonale Planungs- und Baugesetzt definiert ein Hochhaus ab einer Gebäudehöhe von 25 Metern.  

Visualisierung Hochhäuser Stadt Zürich: https://hochhaeuser.stadt-zuerich.ch/

```{r, results = "markup"}

h_hochhaus <- 25

## Anzahl REAL existierender Hochhäuser, basierend auf TRAUFHÖHE

## Wie viele im 2012?
hoch_2012 <- shp_2_5_2012_all %>% filter(sta %in% c("erstellt", "real")) %>%
                                  filter(h_rel_trau > h_hochhaus)
hoch_quartiere_2012 <- hoch_2012 %>% st_drop_geometry() %>% group_by(Quartier) %>%
                                     summarise(Anzahl_2012 = n(),
                                               Area_2012 = sum(area),
                                               Volume_2012 = sum(volume_trauf),
                                                max_height_2012 = max(h_rel_trau))
## Wie viele im aktuell?
hoch_aktuell <- shp_2_5_aktuell_all %>% filter(sta %in% c("erstellt", "real")) %>%
                                        filter(h_rel_trau > h_hochhaus)
hoch_quartiere_aktuell <- hoch_aktuell %>% st_drop_geometry() %>% group_by(Quartier) %>%
                                           summarise(Anzahl_aktuell = n(),
                                                     Area_aktuell = sum(area),
                                                     Volume_aktuell = sum(volume_trauf),
                                                     max_height_aktuell = max(h_rel_trau))


## Wie viele sind aktuell geplant?
hoch_aktuell_geplant <- shp_2_5_aktuell_all %>% filter(sta %in% c("freigegeben", "eingereicht")) %>%
                                                filter(h_rel_trau > h_hochhaus)

hoch_quartiere_aktuell_geplant <- hoch_aktuell_geplant %>% st_drop_geometry() %>% group_by(Quartier) %>%
                                                           summarise(Anzahl_geplant = n(),
                                                                     Area_geplant = sum(area),
                                                                     Volume_geplant = sum(volume_trauf),
                                                                     max_height_geplant = max(h_rel_trau))

## Setze zusammen und berechne Veränderungen
hoch_quartiere <- hoch_quartiere_aktuell %>% left_join(hoch_quartiere_2012, by = "Quartier")
hoch_quartiere <- hoch_quartiere %>% mutate(Anzahl_increase = Anzahl_aktuell - Anzahl_2012 ,
                                            Area_increase = Area_aktuell - Area_2012,
                                            Volume_increase = Volume_aktuell - Volume_2012)

## Ergänze noch geplante Gebäude (eingereichte UND freigegebene Bauprojekte)
hoch_quartiere <- hoch_quartiere %>% left_join(hoch_quartiere_aktuell_geplant, by = "Quartier")

## Tabelle

hoch_quartiere_table <- hoch_quartiere %>% arrange(-Area_aktuell ) %>% 
                                           mutate_at(vars(-Quartier), funs(round(., 0))) 

# knitr::kable(hoch_quartiere_table, caption =  "", digits = 0) %>%
#   kable_styling(bootstrap_options = "striped", full_width = F, fixed_thead = T) %>%
#   scroll_box(width = "1080", height = "250px", fixed_thead = TRUE)


sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 1, ' '),
      th(colspan = 3, 'Stand heute'),
      th(colspan = 2, 'Zuwachs 2012-heute'),
      th(colspan = 3, 'Heute neu geplant')
    ),
    tr(
      lapply(c("Quartier",
               "Fläche [m2]", "Volumen [m3]", "max. Höhe [m]",
               "Fläche [m2]", "Volumen [m3]",
               "Fläche [m2]", "Volumen [m3]", "max. Höhe [m]"), th)
    )
  )
))
# 
# DT::datatable(hoch_quartiere_table,
#               caption = 'Hochhäuser in den Quartieren',
#               class = 'cell-border stripe')



DT::datatable(hoch_quartiere_table[, c("Quartier",
                                       "Area_aktuell", "Volume_aktuell", "max_height_aktuell",
                                       "Area_increase", "Volume_increase",
                                       "Area_geplant", "Volume_geplant", "max_height_geplant")],
              container = sketch, rownames = FALSE,
              caption = 'Volumen und Grundfläche der Hochhäuser',
              class = 'cell-border stripe')
```
